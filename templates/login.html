<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Microsoft Identity Python Web App: Login</title>
    <!-- Teams SDK v2 -->
    <script src="https://statics.teams.cdn.office.net/sdk/v2.0.0/js/MicrosoftTeams.min.js"></script>
    <script>
        // Initialisiere das Teams SDK v2
        microsoftTeams.app.initialize();

        function loginInTeams() {
            // Aufruf der Authentifizierung in Microsoft Teams
            microsoftTeams.authentication.initiateAuth({
                // Diese URL muss in der Azure AD App registriert sein
                url: window.location.origin + "/auth-start",  
                width: 600,
                height: 535,
                successCallback: function (result) {
                    console.log("Login erfolgreich:", result);
                    window.location.href = '/';  // Bei Erfolg zur Startseite weiterleiten
                },
                failureCallback: function (reason) {
                    console.error("Login fehlgeschlagen:", reason);
                    alert("Fehler bei der Authentifizierung: " + reason);
                }
            });
        }

        // Erkennen, ob die Seite innerhalb von Teams geladen wird
        document.addEventListener("DOMContentLoaded", function () {
            microsoftTeams.app.getContext().then(function (context) {
                if (context) {
                    document.getElementById("teamsLoginButton").style.display = "block";
                    document.getElementById("standardLogin").style.display = "none";
                }
            }).catch(function (error) {
                console.error("Fehler beim Abrufen des Teams-Kontexts:", error);
            });
        });
    </script>
</head>
<body>
    <h1>Microsoft Identity Python Web App</h1>

    <!-- Teams-spezifischer Login-Button, der nur angezeigt wird, wenn in Teams -->
    <button id="teamsLoginButton" style="display:none;" onclick="loginInTeams()">Login in Microsoft Teams</button>

    <!-- Standard-Login, falls der Benutzer nicht in Microsoft Teams ist -->
    <div id="standardLogin">
        {% if user_code %}
        <ol>
            <li>To sign in, type <b>{{ user_code }}</b> into
                <a href='{{ auth_uri }}' target=_blank>{{ auth_uri }}</a> to authenticate.
            </li>
            <li>And then <a href="{{ url_for('auth_response') }}">proceed</a>.</li>
        </ol>
        {% else %}
        <ul><li><a href='{{ auth_uri }}'>Sign In</a></li></ul>
        {% endif %}
    </div>

    <hr>
    <footer style="text-align: right">Microsoft identity platform Web App Sample {{ version }}</footer>
</body>
</html>